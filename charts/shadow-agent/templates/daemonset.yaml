apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ .Release.Name }}-agent
  labels:
    app: shadow-agent
spec:
  selector:
    matchLabels:
      app: shadow-agent
  template:
    metadata:
      labels:
        app: shadow-agent
    spec:
      # Critical for GPU access in some environments if not using the operator fully
      # specific configurations depend on the container runtime (docker vs containerd)
      containers:
      - name: agent
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
        securityContext:
          privileged: true # Often needed to access GPU devices directly if not using CDI
        volumeMounts:
          # Mount nvidia-smi if needed, though modern K8s often exposes libraries via device plugin
          # This is a placeholder for where we'd mount /usr/bin/nvidia-smi if necessary
          # - name: nvidia-driver
          #   mountPath: /usr/local/nvidia
        env:
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: spec.nodeName
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
      tolerations:
      - key: "nvidia.com/gpu"
        operator: "Exists"
        effect: "NoSchedule"
